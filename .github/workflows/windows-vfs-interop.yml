name: Windows VFS Interop

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "crates/fsqlite-vfs/**"
      - ".github/workflows/windows-vfs-interop.yml"
  pull_request:
    paths:
      - "crates/fsqlite-vfs/**"
      - ".github/workflows/windows-vfs-interop.yml"

jobs:
  windows-vfs-interop:
    runs-on: windows-latest
    timeout-minutes: 45
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Ensure sqlite3 CLI is available
        shell: pwsh
        run: |
          if (-not (Get-Command sqlite3 -ErrorAction SilentlyContinue)) {
            choco install sqlite --yes --no-progress
            $env:Path += ";C:\ProgramData\chocolatey\bin"
          }
          $sqlite = Get-Command sqlite3 -ErrorAction SilentlyContinue
          if (-not $sqlite) {
            throw "sqlite3 CLI is required for test_e2e_windowsvfs_c_sqlite_interop"
          }
          sqlite3 --version

      - name: Create artifacts directory
        shell: pwsh
        run: New-Item -ItemType Directory -Path artifacts -Force | Out-Null

      - name: Check fsqlite-vfs
        shell: pwsh
        run: cargo check -p fsqlite-vfs --all-targets 2>&1 | Tee-Object -FilePath artifacts/cargo-check-fsqlite-vfs.txt

      - name: Clippy fsqlite-vfs
        shell: pwsh
        run: cargo clippy -p fsqlite-vfs --all-targets -- -D warnings 2>&1 | Tee-Object -FilePath artifacts/cargo-clippy-fsqlite-vfs.txt

      - name: Run full fsqlite-vfs tests
        shell: pwsh
        run: cargo test -p fsqlite-vfs -- --nocapture 2>&1 | Tee-Object -FilePath artifacts/cargo-test-fsqlite-vfs.txt

      - name: Run Windows interop E2E test
        shell: pwsh
        run: cargo test -p fsqlite-vfs test_e2e_windowsvfs_c_sqlite_interop -- --nocapture 2>&1 | Tee-Object -FilePath artifacts/cargo-test-windows-interop.txt

      - name: Upload Windows VFS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-vfs-interop-logs
          path: artifacts/
