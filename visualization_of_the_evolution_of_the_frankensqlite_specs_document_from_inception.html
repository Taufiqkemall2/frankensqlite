<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FrankenSQLite Spec Evolution</title>
    <meta name="description" content="Interactive visualization of 137 commits across 12 deep sessions building a 10,791-line comprehensive database specification." />
    
    <!-- OpenGraph & Favicon -->
    <meta property="og:title" content="FrankenSQLite Spec Evolution" />
    <meta property="og:description" content="137 commits · 10,791 lines · 12 sessions of deep architectural design." />
    <meta property="og:image" content="og-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="twitter-image.png" />
    <link rel="icon" type="image/webp" href="frankensqlite_illustration.webp" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
    <link rel="stylesheet" href="frankentui.css" />
    
    <style>
        /* Specific overrides for this viz tool */
        .main-container { flex: 1; display: flex; overflow: hidden; position: relative; }
        .sidebar { width: 320px; border-right: 1px solid var(--dim-color); display: flex; flex-direction: column; background: var(--bg-color); flex-shrink: 0; }
        .content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #080808; }
        
        .pane-header { padding: 0.5rem 1rem; background: #0f0f0f; border-bottom: 1px solid var(--dim-color); font-size: 0.75rem; text-transform: uppercase; font-weight: bold; color: var(--fg-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 40px; }
        .pane-scroll { flex: 1; overflow-y: auto; padding: 1rem; position: relative; }
        
        /* Commit List */
        .commit-item { border: 1px solid var(--dim-color); padding: 0.75rem; margin-bottom: 0.5rem; background: #0a0a0a; cursor: pointer; transition: all 0.1s; }
        .commit-item:hover { border-color: var(--fg-color); background: #111; }
        .commit-item.selected { border: 1px solid var(--fg-color); box-shadow: 0 0 10px rgba(51, 255, 0, 0.1); background: #0f150f; }
        
        /* Dock */
        .dock { height: 80px; background: #000; border-top: 1px solid var(--border-color); padding: 0.5rem 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 100; flex-shrink: 0; }
        .dock-controls { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; }
        .dock-canvas { width: 100%; height: 30px; display: block; }
        input[type="range"] { width: 100%; accent-color: var(--fg-color); height: 4px; background: var(--dim-color); border: none; }
        
        /* Charts */
        .chart-container { width: 100%; height: 100%; min-height: 200px; position: relative; }
        
        /* Markdown */
        .doc-view { padding-right: 1rem; max-width: 900px; margin: 0 auto; color: #ccc; font-size: 0.9rem; line-height: 1.6; }
        .doc-view h1, .doc-view h2, .doc-view h3 { color: var(--fg-color); border-bottom: 1px dashed var(--dim-color); padding-bottom: 0.5rem; margin-top: 2rem; }
        .doc-view code { color: #bd00ff; background: #151515; padding: 2px 4px; border-radius: 3px; font-size: 0.85em; }
        .doc-view pre { background: #111; border: 1px solid var(--dim-color); padding: 1rem; overflow-x: auto; margin: 1rem 0; }
        
        /* Search Palette */
        #searchPaletteOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: flex; justify-content: center; align-items: flex-start; padding-top: 100px; }
        .search-palette { width: 600px; background: #000; border: 1px solid var(--fg-color); padding: 0; box-shadow: 0 0 20px rgba(51, 255, 0, 0.2); }
        .search-palette-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--dim-color); padding: 1rem; font-size: 1.2rem; color: var(--fg-color); font-family: 'JetBrains Mono'; outline: none; }
        .search-palette-results { max-height: 400px; overflow-y: auto; padding: 0.5rem; }
        .search-palette-item { padding: 0.5rem; cursor: pointer; display: flex; gap: 1rem; align-items: center; color: #888; }
        .search-palette-item:hover, .search-palette-item.active { background: #111; border-left: 2px solid var(--fg-color); color: #fff; }
        .search-palette-hint { color: #555; padding: 1rem; text-align: center; font-style: italic; }
        .search-palette-footer { padding: 0.5rem; border-top: 1px solid var(--dim-color); display: flex; justify-content: flex-end; gap: 1rem; font-size: 0.7rem; color: #555; }

        /* KPI */
        .kpi-bar { display: flex; gap: 1.5rem; font-size: 0.8rem; }
        .kpi-val { color: #fff; font-weight: bold; }
    </style>
</head>
<body>

<header class="tui-header">
    <div class="flex items-center gap-4">
        <h1>FrankenSQLite</h1>
        <div class="kpi-bar">
            <span>Commits: <span id="kpiCommits" class="kpi-val">-</span></span>
            <span>Groups: <span id="kpiGroups" class="kpi-val">-</span></span>
            <span>Lines: <span id="kpiLines" class="kpi-val">-</span></span>
        </div>
    </div>
    <div class="flex gap-2">
        <button id="btnGalaxy" title="Alien math visualization">Galaxy Brain</button>
        <button onclick="window.open('https://github.com/Dicklesworthstone/frankensqlite')">GitHub</button>
    </div>
</header>

<div class="main-container">
    <aside class="sidebar">
        <div class="pane-header">Filters</div>
        <div class="pane-scroll">
            <div class="mb-4">
                <input id="q" type="text" placeholder="Search commits (regex)..." class="mb-2">
                <div class="flex justify-between text-xs text-dim mb-1"><span>Min Impact</span><span id="impactLabel">0</span></div>
                <input id="impact" type="range" min="0" max="200" value="0">
            </div>
            <div class="mb-4">
                <div class="text-xs font-bold mb-2 text-dim uppercase">Bucket Mode</div>
                <div class="flex gap-2">
                    <button id="modePrimary" class="active flex-1">Primary</button>
                    <button id="modeMulti" class="flex-1">Multi</button>
                </div>
            </div>
            <div id="bucketToggles" class="flex flex-col gap-1 mb-4"></div>
            <div class="text-xs font-bold mb-2 text-dim uppercase">Commits</div>
            <div id="commitList"></div>
        </div>
    </aside>

    <main class="content-area">
        <div class="pane-header">
            <div class="flex gap-2">
                <button id="tabTimeline" class="active">Timeline</button>
                <button id="tabSpec">Spec</button>
                <button id="tabDiff">Diff</button>
                <button id="tabStats">Stats</button>
            </div>
            <div id="docCommitTitle" class="text-xs truncate" style="max-width: 400px; color: #fff;"></div>
        </div>
        
        <div class="pane-scroll" id="mainPaneContent">
            <div id="viewTimeline" class="h-full flex flex-col gap-4">
                <div class="tui-panel" style="flex: 1; padding: 10px;">
                    <div id="timelineChart" class="chart-container"></div>
                </div>
                <div class="tui-panel" style="flex: 1; padding: 10px;">
                    <div id="stackChart" class="chart-container"></div>
                </div>
            </div>

            <div id="viewSpec" class="hidden h-full"><div id="docRendered" class="doc-view"></div></div>
            <div id="viewDiff" class="hidden h-full"><div id="diffContent"></div></div>
            
            <div id="viewStats" class="hidden h-full">
                <div class="flex gap-4 h-full">
                    <div class="tui-panel" style="flex: 1; padding: 10px;">
                        <h3 class="text-xs font-bold mb-2 text-dim uppercase text-center">Distribution</h3>
                        <div id="donutChart" class="chart-container"></div>
                    </div>
                    <div class="tui-panel" style="flex: 1; padding: 10px;">
                        <h3 class="text-xs font-bold mb-2 text-dim uppercase text-center">Telemetry</h3>
                        <div id="bocpdChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            
            <div id="loadingOverlay" class="absolute inset-0 bg-black/90 flex items-center justify-center z-50">
                <div class="text-center"><div class="text-xl mb-2" style="color:var(--fg-color)">LOADING</div><div class="text-xs text-dim">SQLite via sql.js</div></div>
            </div>
        </div>
    </main>
</div>

<div class="dock">
    <div class="dock-controls">
        <div class="flex gap-2"><button id="dockPrev">&lt;</button><button id="dockPlay">PLAY</button><button id="dockNext">&gt;</button></div>
        <div id="dockLabel" class="font-mono text-dim"></div>
    </div>
    <canvas id="dockCanvas" class="dock-canvas"></canvas>
    <input id="dockSlider" type="range" min="0" max="100" value="0">
</div>

<!-- Search Palette -->
<div id="searchPalette" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-start justify-center pt-20">
    <div class="search-palette">
        <input id="searchPaletteInput" type="text" class="search-palette-input" placeholder="> Type to search history (e.g. 'MVCC', 'RaptorQ')...">
        <div id="searchPaletteResults" class="search-palette-results"></div>
        <div class="search-palette-footer"><span>&uarr;&darr; to navigate</span><span>ENTER to jump</span><span>ESC to close</span></div>
    </div>
</div>

<!-- Deps -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.0/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/diff@7.0.0/dist/diff.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>

<script type="module">
    const DB_URL = "spec_evolution_v1.sqlite3";
    const COLORS = ["#39ff14", "#adff2f", "#00ff00", "#ff003c", "#94a3b8", "#d946ef", "#00f2ff", "#bf00ff", "#00ffcc", "#475569"];
    const BUCKETS = [
        { id: 1, name: "Logic/Math", color: COLORS[0] }, { id: 2, name: "SQLite Legacy", color: COLORS[1] },
        { id: 3, name: "Asupersync", color: COLORS[2] }, { id: 4, name: "Arch Fixes", color: COLORS[3] },
        { id: 5, name: "Scrivening", color: COLORS[4] }, { id: 6, name: "Context", color: COLORS[5] },
        { id: 7, name: "Standard Eng", color: COLORS[6] }, { id: 8, name: "Alien Math", color: COLORS[7] },
        { id: 9, name: "Clarification", color: COLORS[8] }, { id: 10, name: "Other", color: COLORS[9] }
    ];

    let DB = null;
    let COMMITS = [];
    let FILTERED = [];
    let PATCH_CACHE = new Map();
    let DOC_CACHE = new Map();
    let BASE_DOC = "";
    
    const STATE = { idx: 0, q: "", minImpact: 0, bucketMode: "primary", bucketEnabled: new Set(BUCKETS.map(b => b.id)), tab: "timeline" };

    async function init() {
        try {
            const SQL = await window.initSqlJs({ locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/${file}` });
            const res = await fetch(DB_URL);
            const buf = await res.arrayBuffer();
            DB = new SQL.Database(new Uint8Array(buf));
            const baseRes = DB.exec("SELECT text FROM base_doc LIMIT 1");
            if (baseRes.length) BASE_DOC = baseRes[0].values[0][0];
            loadCommits();
            document.getElementById("loadingOverlay").classList.add("hidden");
            renderBucketToggles();
            render();
            window.addEventListener("resize", () => { chartTimeline?.resize(); chartStack?.resize(); chartDonut?.resize(); chartBocpd?.resize(); drawDockCanvas(); });
        } catch (e) {
            console.error(e);
            document.getElementById("loadingOverlay").innerHTML = `<div class="text-red-500">ERROR<br>${e}</div>`;
        }
    }

    function loadCommits() {
        const res = DB.exec("SELECT idx, hash, short, date_iso, author, subject, add_lines, del_lines, impact, primary_bucket, labels_json FROM commits ORDER BY idx ASC");
        if (!res.length) return;
        COMMITS = res[0].values.map(r => ({ idx: r[0], hash: r[1], short: r[2], date: r[3], author: r[4], subject: r[5], add: r[6], del: r[7], impact: r[8], primary: r[9], labels: JSON.parse(r[10] || "[]") }));
        document.getElementById("dockSlider").max = COMMITS.length - 1;
        document.getElementById("kpiCommits").textContent = COMMITS.length;
        document.getElementById("kpiLines").textContent = COMMITS.reduce((s, c) => s + c.impact, 0).toLocaleString();
        selectCommit(COMMITS.length - 1);
    }

    function render() {
        filterCommits();
        renderCommitList();
        renderCharts();
        renderStats();
        updateDock();
        updateView();
    }

    function filterCommits() {
        const q = STATE.q.toLowerCase();
        FILTERED = COMMITS.filter(c => {
            if (c.impact < STATE.minImpact) return false;
            if (q) { try { if (!new RegExp(q).test(c.subject.toLowerCase()) && !c.hash.includes(q)) return false; } catch { if (!c.subject.toLowerCase().includes(q)) return false; } }
            if (STATE.bucketMode === "primary") return STATE.bucketEnabled.has(c.primary);
            return c.labels.some(l => STATE.bucketEnabled.has(l));
        });
        document.getElementById("kpiGroups").textContent = FILTERED.length;
    }

    function renderCommitList() {
        const el = document.getElementById("commitList");
        const visible = FILTERED.slice(0, 150);
        el.innerHTML = visible.map(c => {
            const b = BUCKETS.find(x => x.id === c.primary) || BUCKETS[9];
            const isSel = c.idx === STATE.idx ? "selected" : "";
            return `<div class="commit-item ${isSel}" onclick="selectCommit(${c.idx})"><div class="flex justify-between mb-1"><span class="font-mono text-xs text-dim">#${c.idx} ${c.short}</span><span class="text-xs" style="color:${b.color}">${b.name}</span></div><div class="text-xs mb-1" style="color:#eee">${escapeHtml(c.subject)}</div><div class="text-xs text-dim">+${c.add} -${c.del}</div></div>`;
        }).join("");
    }

    window.selectCommit = function(idx) {
        STATE.idx = idx;
        document.getElementById("dockSlider").value = idx;
        renderCommitList();
        updateDock();
        updateView();
    };

    function updateDock() {
        const c = COMMITS[STATE.idx];
        if (!c) return;
        document.getElementById("dockLabel").textContent = `${c.short} [${c.date.slice(0, 16)}] ${c.subject}`;
        drawDockCanvas();
    }

    function drawDockCanvas() {
        const cvs = document.getElementById("dockCanvas");
        const ctx = cvs.getContext("2d");
        const w = cvs.width = cvs.clientWidth;
        const h = cvs.height = cvs.clientHeight;
        if (!w || !h) return;
        ctx.clearRect(0, 0, w, h);
        const barW = w / COMMITS.length;
        COMMITS.forEach((c, i) => {
            const b = BUCKETS.find(x => x.id === c.primary) || BUCKETS[9];
            ctx.fillStyle = b.color;
            ctx.globalAlpha = 0.8;
            const hh = Math.max(2, Math.min(h, (c.impact / 200) * h));
            ctx.fillRect(i * barW, h - hh, Math.max(1, barW), hh);
        });
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = "#fff";
        ctx.fillRect(STATE.idx * barW, 0, Math.max(2, barW), h);
        ctx.shadowColor = "#fff"; ctx.shadowBlur = 10;
        ctx.fillRect(STATE.idx * barW, 0, Math.max(2, barW), h);
        ctx.shadowBlur = 0;
    }

    async function updateView() {
        const c = COMMITS[STATE.idx];
        if (!c) return;
        document.getElementById("docCommitTitle").textContent = `#${c.idx} ${c.subject}`;
        if (STATE.tab === "spec") {
            const el = document.getElementById("docRendered");
            el.innerHTML = '<div class="text-dim">Reconstructing...</div>';
            await new Promise(r => setTimeout(r, 10));
            const text = await reconstructSnapshot(STATE.idx);
            if (window.markdownit) {
                const md = window.markdownit({ html: true });
                el.innerHTML = md.render(text);
                if (window.hljs) el.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
            } else el.innerText = text;
        } else if (STATE.tab === "diff") {
            const patch = await getPatch(STATE.idx);
            const el = document.getElementById("diffContent");
            if (window.Diff2Html) {
                el.innerHTML = Diff2Html.html(patch, { drawFileList: false, matching: 'lines', outputFormat: 'side-by-side', colorScheme: 'dark' });
            } else el.innerHTML = `<pre>${escapeHtml(patch)}</pre>`;
        }
    }

    async function reconstructSnapshot(targetIdx) {
        if (DOC_CACHE.has(targetIdx)) return DOC_CACHE.get(targetIdx);
        let lines = BASE_DOC.split("\\n");
        for (let i = 1; i <= targetIdx; i++) {
            const patch = await getPatch(i);
            if (!patch) continue;
            lines = applyPatch(lines, patch);
        }
        const result = lines.join("\\n");
        DOC_CACHE.set(targetIdx, result);
        return result;
    }

    function applyPatch(lines, patch) {
        const hunks = parseHunks(patch);
        const newLines = [...lines];
        let offset = 0;
        hunks.forEach(hunk => {
            const start = hunk.oldStart - 1 + offset;
            const newSegment = hunk.lines.filter(l => !l.startsWith("-")).map(l => l.startsWith("+") ? l.slice(1) : l.slice(1));
            newLines.splice(start, hunk.oldCount, ...newSegment);
            offset += (hunk.newCount - hunk.oldCount);
        });
        return newLines;
    }

    function parseHunks(patch) {
        const hunks = [];
        const lines = patch.split("\\n");
        let currentHunk = null;
        lines.forEach(line => {
            if (line.startsWith("@@")) {
                if (currentHunk) hunks.push(currentHunk);
                const m = line.match(/@@ -(\\d+)(?:,(\\d+))? \\+(\\d+)(?:,(\\d+))? @@/);
                if (m) currentHunk = { oldStart: parseInt(m[1]), oldCount: parseInt(m[2] || "1"), newStart: parseInt(m[3]), newCount: parseInt(m[4] || "1"), lines: [] };
            } else if (currentHunk && !line.startsWith("---") && !line.startsWith("+++") && !line.startsWith("index")) {
                currentHunk.lines.push(line);
            }
        });
        if (currentHunk) hunks.push(currentHunk);
        return hunks;
    }

    async function getPatch(idx) {
        if (PATCH_CACHE.has(idx)) return PATCH_CACHE.get(idx);
        const res = DB.exec("SELECT patch FROM patches WHERE idx = ?", [idx]);
        const p = res.length ? res[0].values[0][0] : "";
        PATCH_CACHE.set(idx, p);
        return p;
    }

    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }

    let chartTimeline, chartStack, chartDonut, chartBocpd;
    function renderCharts() {
        if (STATE.tab !== "timeline") return;
        const opts = { backgroundColor: 'transparent', textStyle: { fontFamily: 'JetBrains Mono' }, grid: { top: 30, bottom: 30, left: 50, right: 20 }, tooltip: { trigger: 'item', backgroundColor: '#111', borderColor: '#33ff00', textStyle: { color: '#eee' } } };
        if (!chartTimeline) chartTimeline = echarts.init(document.getElementById("timelineChart"));
        const scatData = FILTERED.map(c => [c.date, c.impact, c.primary, c.subject]);
        chartTimeline.setOption({ ...opts, title: { text: 'IMPACT OVER TIME', left: 'center', textStyle: { color: '#666', fontSize: 10 } }, xAxis: { type: 'time', splitLine: { show: false }, axisLabel: { color: '#666' } }, yAxis: { type: 'value', splitLine: { lineStyle: { color: '#111' } }, axisLabel: { color: '#666' } }, series: [{ type: 'scatter', data: scatData, symbolSize: d => Math.min(30, 4 + Math.sqrt(d[1])), itemStyle: { color: d => BUCKETS.find(b => b.id === d[2])?.color } }] });
        if (!chartStack) chartStack = echarts.init(document.getElementById("stackChart"));
        const days = {}; FILTERED.forEach(c => { const d = c.date.slice(0, 10); if (!days[d]) days[d] = {}; days[d][c.primary] = (days[d][c.primary] || 0) + c.impact; });
        const xDays = Object.keys(days).sort();
        const series = BUCKETS.map(b => ({ name: b.name, type: 'bar', stack: 'total', itemStyle: { color: b.color }, data: xDays.map(d => days[d][b.id] || 0) }));
        chartStack.setOption({ ...opts, title: { text: 'IMPACT BY BUCKET (DAILY)', left: 'center', textStyle: { color: '#666', fontSize: 10 } }, tooltip: { trigger: 'axis', backgroundColor: '#111', borderColor: '#33ff00', textStyle: { color: '#eee' } }, xAxis: { type: 'category', data: xDays, axisLabel: { color: '#666' } }, yAxis: { type: 'value', splitLine: { lineStyle: { color: '#111' } }, axisLabel: { color: '#666' } }, series });
    }

    function renderStats() {
        if (STATE.tab !== "stats") return;
        const opts = { backgroundColor: 'transparent', textStyle: { fontFamily: 'JetBrains Mono' } };
        if (!chartDonut) chartDonut = echarts.init(document.getElementById("donutChart"));
        const counts = {}; FILTERED.forEach(c => counts[c.primary] = (counts[c.primary] || 0) + 1);
        const pieData = BUCKETS.map(b => ({ value: counts[b.id] || 0, name: b.name, itemStyle: { color: b.color } })).filter(d => d.value > 0);
        chartDonut.setOption({ ...opts, tooltip: { trigger: 'item' }, series: [{ type: 'pie', radius: ['40%', '70%'], data: pieData, label: { color: '#ccc' } }] });
        if (!chartBocpd) chartBocpd = echarts.init(document.getElementById("bocpdChart"));
        const lineData = COMMITS.map(c => [c.idx, Math.log1p(c.impact)]);
        chartBocpd.setOption({ ...opts, tooltip: { trigger: 'axis' }, xAxis: { type: 'value', show: false }, yAxis: { type: 'value', show: false }, series: [{ type: 'line', data: lineData, showSymbol: false, lineStyle: { color: '#bd00ff', width: 1 } }] });
    }

    function renderBucketToggles() {
        const bucketContainer = document.getElementById("bucketToggles");
        bucketContainer.innerHTML = "";
        BUCKETS.forEach(b => {
            const div = document.createElement("div");
            div.className = "flex items-center gap-2 text-xs cursor-pointer select-none text-dim hover:text-white";
            div.style.padding = "2px 0";
            div.innerHTML = `<span id="bind-${b.id}" style="width:8px;height:8px;background:${b.color};display:inline-block;border-radius:2px;"></span> ${b.name}`;
            div.onclick = () => {
                if (STATE.bucketEnabled.has(b.id)) STATE.bucketEnabled.delete(b.id); else STATE.bucketEnabled.add(b.id);
                const span = document.getElementById(`bind-${b.id}`);
                span.style.opacity = STATE.bucketEnabled.has(b.id) ? 1 : 0.2;
                div.style.opacity = STATE.bucketEnabled.has(b.id) ? 1 : 0.5;
                render();
            };
            bucketContainer.appendChild(div);
        });
    }

    document.getElementById("q").addEventListener("input", e => { STATE.q = e.target.value; render(); });
    document.getElementById("impact").addEventListener("input", e => { STATE.minImpact = Number(e.target.value); document.getElementById("impactLabel").textContent = STATE.minImpact; render(); });
    document.getElementById("modePrimary").addEventListener("click", () => { STATE.bucketMode = "primary"; render(); document.getElementById("modeMulti").classList.remove("active"); document.getElementById("modePrimary").classList.add("active"); });
    document.getElementById("modeMulti").addEventListener("click", () => { STATE.bucketMode = "multi"; render(); document.getElementById("modePrimary").classList.remove("active"); document.getElementById("modeMulti").classList.add("active"); });
    ["tabTimeline", "tabSpec", "tabDiff", "tabStats"].forEach(id => {
        document.getElementById(id).addEventListener("click", e => {
            document.querySelectorAll(".pane-header button").forEach(b => b.classList.remove("active"));
            e.target.classList.add("active");
            STATE.tab = id.replace("tab", "").toLowerCase();
            ["viewTimeline", "viewSpec", "viewDiff", "viewStats"].forEach(v => document.getElementById(v).classList.add("hidden"));
            document.getElementById("view" + id.replace("tab", "")).classList.remove("hidden");
            render();
        });
    });
    
    let playTimer = null;
    document.getElementById("dockPlay").addEventListener("click", () => {
        if (playTimer) { clearInterval(playTimer); playTimer = null; document.getElementById("dockPlay").textContent = "PLAY"; }
        else { document.getElementById("dockPlay").textContent = "PAUSE"; playTimer = setInterval(() => { if (STATE.idx < COMMITS.length - 1) selectCommit(STATE.idx + 1); else { clearInterval(playTimer); playTimer = null; document.getElementById("dockPlay").textContent = "PLAY"; } }, 150); }
    });
    document.getElementById("dockPrev").addEventListener("click", () => { if (STATE.idx > 0) selectCommit(STATE.idx - 1); });
    document.getElementById("dockNext").addEventListener("click", () => { if (STATE.idx < COMMITS.length - 1) selectCommit(STATE.idx + 1); });
    document.getElementById("btnGalaxy").addEventListener("click", () => { document.getElementById("tabStats").click(); });

    // Search Palette
    document.addEventListener("keydown", e => {
        if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
            e.preventDefault();
            document.getElementById("searchPalette").classList.remove("hidden");
            document.getElementById("searchPaletteInput").focus();
        }
        if (e.key === "Escape") {
            document.getElementById("searchPalette").classList.add("hidden");
        }
    });
    
    document.getElementById("searchPaletteInput").addEventListener("input", e => {
        const q = e.target.value.toLowerCase();
        const results = document.getElementById("searchPaletteResults");
        if (!q) { results.innerHTML = ""; return; }
        const hits = COMMITS.filter(c => c.subject.toLowerCase().includes(q) || c.hash.includes(q)).slice(0, 20);
        results.innerHTML = hits.map(c => `<div class="search-palette-item" onclick="selectCommit(${c.idx}); document.getElementById('searchPalette').classList.add('hidden')">#${c.idx} ${c.subject}</div>`).join("");
    });

    init();
</script>
</body>
</html>